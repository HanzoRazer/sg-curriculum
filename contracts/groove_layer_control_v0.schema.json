{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "sg://contracts/groove_layer_control_v0.schema.json",
  "title": "Groove Layer Control v0",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_id",
    "schema_version",
    "emitted_at_utc",
    "device_id",
    "session_id",
    "window",
    "controls"
  ],
  "properties": {
    "schema_id": {
      "type": "string",
      "const": "groove_layer_control"
    },
    "schema_version": {
      "type": "string",
      "const": "v0"
    },

    "emitted_at_utc": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp when this control message was emitted."
    },

    "device_id": {
      "type": "string",
      "minLength": 6,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9][A-Za-z0-9._:-]{4,126}[A-Za-z0-9]$",
      "description": "Device-local identity for this Smart Guitar unit (NOT player identity)."
    },
    "session_id": {
      "type": "string",
      "minLength": 8,
      "maxLength": 128,
      "description": "Device-local session identifier (no global user identity)."
    },

    "window": {
      "type": "object",
      "additionalProperties": false,
      "required": ["window_start_utc", "window_end_utc", "duration_ms", "event_count", "confidence"],
      "properties": {
        "window_start_utc": { "type": "string", "format": "date-time" },
        "window_end_utc": { "type": "string", "format": "date-time" },
        "duration_ms": { "type": "integer", "minimum": 1000, "maximum": 120000 },
        "event_count": { "type": "integer", "minimum": 0, "maximum": 100000 },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Overall evidence quality for this window; low confidence should reduce downstream aggressiveness."
        }
      }
    },

    "controls": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "tempo",
        "arrangement",
        "loop",
        "feel",
        "assist",
        "change_policy"
      ],
      "properties": {
        "tempo": {
          "type": "object",
          "additionalProperties": false,
          "required": ["policy", "nudge_strength", "max_delta_pct_per_min"],
          "properties": {
            "policy": {
              "type": "string",
              "enum": ["follow_player", "steady_clock", "gentle_nudge"],
              "description": "How accompaniment tempo behaves relative to observed player tempo."
            },
            "target_bpm": {
              "type": "number",
              "minimum": 20,
              "maximum": 260,
              "description": "Optional explicit target (only meaningful for steady_clock / gentle_nudge)."
            },
            "nudge_strength": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "0 = no nudging, 1 = strongest correction allowed."
            },
            "max_delta_pct_per_min": {
              "type": "number",
              "minimum": 0,
              "maximum": 20,
              "description": "Hard guardrail limiting tempo drift to prevent surprise."
            }
          }
        },

        "arrangement": {
          "type": "object",
          "additionalProperties": false,
          "required": ["density_target", "instrumentation_policy", "dynamics_follow"],
          "properties": {
            "density_target": {
              "type": "string",
              "enum": ["sparse", "medium", "full"],
              "description": "Arrangement thickness target."
            },
            "instrumentation_policy": {
              "type": "string",
              "enum": ["reduce_layers", "keep_layers", "add_layers"],
              "description": "Whether to simplify or enrich instrumentation."
            },
            "dynamics_follow": {
              "type": "string",
              "enum": ["follow_player", "fixed", "soft_follow"],
              "description": "How accompaniment reacts to player dynamics (attack/velocity)."
            }
          }
        },

        "loop": {
          "type": "object",
          "additionalProperties": false,
          "required": ["policy", "length_bars", "exit_condition"],
          "properties": {
            "policy": {
              "type": "string",
              "enum": ["none", "loop_section", "micro_loop"],
              "description": "Looping mode for practice."
            },
            "length_bars": {
              "type": "integer",
              "minimum": 1,
              "maximum": 32,
              "description": "Loop length in bars (engine interprets with current time signature)."
            },
            "exit_condition": {
              "type": "string",
              "enum": ["manual", "stability_recovered", "time_elapsed"],
              "description": "How the system exits loop mode."
            },
            "time_elapsed_s": {
              "type": "integer",
              "minimum": 5,
              "maximum": 600,
              "description": "Only if exit_condition=time_elapsed."
            }
          }
        },

        "feel": {
          "type": "object",
          "additionalProperties": false,
          "required": ["feel_policy", "grid", "click_policy"],
          "properties": {
            "feel_policy": {
              "type": "string",
              "enum": ["straight", "swing", "hybrid"],
              "description": "Preferred rhythmic feel."
            },
            "grid": {
              "type": "string",
              "enum": ["quarter", "eighth", "sixteenth", "triplet"],
              "description": "Intended rhythmic subdivision grid."
            },
            "click_policy": {
              "type": "string",
              "enum": ["off", "subtle", "prominent"],
              "description": "Metronome/click salience (if present)."
            }
          }
        },

        "assist": {
          "type": "object",
          "additionalProperties": false,
          "required": ["assist_policy", "ghost_drums", "count_in_bars"],
          "properties": {
            "assist_policy": {
              "type": "string",
              "enum": ["minimal", "standard", "supportive"],
              "description": "Overall assistiveness level."
            },
            "ghost_drums": {
              "type": "string",
              "enum": ["off", "light", "strong"],
              "description": "How much rhythmic scaffolding is present."
            },
            "count_in_bars": {
              "type": "integer",
              "minimum": 0,
              "maximum": 8,
              "description": "Number of bars to count-in before playing."
            }
          }
        },

        "change_policy": {
          "type": "object",
          "additionalProperties": false,
          "required": ["allow_modulation", "allow_tempo_change_events", "allow_density_probes"],
          "properties": {
            "allow_modulation": { "type": "boolean" },
            "allow_tempo_change_events": { "type": "boolean" },
            "allow_density_probes": {
              "type": "boolean",
              "description": "Whether the system may run short controlled probes to learn preferences."
            }
          }
        }
      }
    },

    "rationale": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional internal explainability hooks (NOT user-facing).",
      "properties": {
        "trigger": {
          "type": "string",
          "enum": [
            "low_tempo_stability",
            "high_microtiming_bias",
            "low_subdivision_confidence",
            "slow_error_recovery",
            "fatigue_detected",
            "preference_probe",
            "manual_override"
          ]
        },
        "notes": { "type": "string", "maxLength": 2000 }
      }
    },

    "privacy": {
      "type": "object",
      "additionalProperties": false,
      "description": "Explicit boundary reminders: no player identity, no lesson ids, no audio/midi blobs.",
      "required": ["contains_player_identity", "contains_pedagogy", "contains_audio_midi"],
      "properties": {
        "contains_player_identity": { "type": "boolean", "const": false },
        "contains_pedagogy": { "type": "boolean", "const": false },
        "contains_audio_midi": { "type": "boolean", "const": false }
      }
    }
  }
}
